# SpecPlot - 光谱数据处理与绘图工具
> **注意**：本程序处于开发初期（版本 0.2），部分功能可能不稳定，配置文件格式可能在未来版本中调整。建议每次更新代码后重新测试您的配置。

## 项目描述

SpecPlot 是一个基于 Python 的光谱数据可视化和分析工具，主要用于处理实验室常见的光谱数据，目前包括：

- **稳态光谱**：紫外-可见吸收光谱（UV-Vis）、荧光光谱
- **瞬态光谱**：瞬态吸收光谱（TA）
- **动力学数据**：吸收/发射动力学问题、时间相关单光子计数（TC-SPC）

程序通过读取用户提供的 JSON 配置文件来定义数据处理流程和绘图样式，支持多组数据叠加、数据运算（如差谱、平均）、曲线拟合（包括多种指数衰减、上升、二级反应模型）、基线校正、仪器响应函数（IRF）卷积拟合等功能。拟合结果在输出至终端的同时，会以文本形式显示在图上，并可保存为 PNG 图片。

## 使用技术

- **语言**：Python 3.6+
- **核心依赖**：
  - `numpy` ~= 1.21
  - `scipy` ~= 1.7
  - `matplotlib` ~= 3.4
  - `tkinter`（通常 Python 自带）
- **可选/间接依赖**：无特殊要求

## 环境要求

### 系统要求
- Windows / Linux / macOS（需支持 tkinter 图形界面）
- 显示器分辨率建议 1280×720 以上（用于正常显示绘图窗口）

### Python 环境
- 安装 Python 3.6 或更高版本
- 推荐使用虚拟环境（如 `venv` 或 `conda`）隔离项目依赖

### 安装依赖
在项目目录下运行：
```bash
pip install numpy scipy matplotlib
```
（如果希望使用系统字体或更多绘图功能，可安装 `freetype` 等，但非必需）

## 快速开始

### 1. 准备数据文件
数据文件应为文本文件（`.txt`），数据行每行包含两个数值（x 和 y），可包含非数据行。
数据文件必须以`RunXX`为开头，其中XX为2位数字，10以下的数字应使用"0X"表示。例如：
 `Run01_UV_样品A.txt`

### 2. 编写 JSON 配置文件
在同一目录下，创建一个 JSON 文件（如 `config.json`），定义要处理的数据、参数和绘图样式。
一个简单的示例：
```json
{
    "TYPE": "UV",
    "RUN_LIST": [1, 2, 3],
    "CONCENTRATION": [0.95, 0.50, 1.23],
    "LABEL_LIST": ["Sample A", "Sample B", "Sample C"],
    "TITLE0": "My Samples",
    "XMIN": 300,
    "XMAX": 800,
    "NORMALIZATION_METHOD": 1
}
```
详细配置项说明请参考下文“关键词目录”。

### 3. 运行程序
在终端中执行：
```bash
python spec_plot.py
```
程序会弹出文件选择对话框，选择你的 JSON 配置文件后自动绘图。
亦可直接在命令行中指定输入文件：
```bash
python spec_plot.py your_file_path/config.json
```
输入后，终端窗口将显示部分作图信息，同时所生成的图谱也将呈现于绘图窗口。
你可以在此界面进行进一步的操作（缩放、定位等），或保存当前图片。
图片的文件名会自动复制到你的剪贴板中。

### 4. 交互操作
关闭绘图窗口后，会回到终端，然后可以输入以下命令：
- `n`：选择新的 JSON 文件重新绘图
- `r`：重新加载当前 JSON 文件并绘图
- `v`：显示版本信息
- `h`：显示帮助
- 其他任意键：退出程序
输入命令前，你可以修改当前载入的 JSON 文件并保存以对当前的图进行调整，或准备新的 JSON 文件。

## 关键词目录

在 JSON 配置文件中，可使用以下关键词（区分大小写）定义数据处理和绘图参数。所有参数均有默认值，未指定时将采用程序内置默认值。

### 基本设置
| 关键词 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `TYPE` | 字符串 | `""` | 数据类型：`"UV"`（紫外可见吸收）、`"TA"`（瞬态吸收）、`"FL"/"E00"`（荧光）、`"EX"`（激发谱）、`"EM"`（发射谱）、`"KinAbs"/"KA"`（吸收动力学）、`"TC-SPC"`（时间相关单光子计数）。影响坐标轴标签和默认行为。 |
| `RUN_LIST` | 数组 | `[]` | **必须**。要处理的数据运行编号列表，例如 `[1,2,3]`。也支持算式字符串如 `"1-2"`（差谱）或 `"1+2+3"`（平均）。 该功能尚待进一步完善。|
| `RUN_DIR` | 字符串 | `None` | 数据文件所在目录的相对路径（相对于当前工作目录）。若未提供，程序自动使用 JSON 文件所在目录。 |
| `CONCENTRATION` | 数字或数组 | `[1.0]` | 每个运行对应的浓度值（**单位：mmol/L**），用于归一化至摩尔吸光系数。长度不足时重复最后一个值。 |
| `LENGTH` | 数字 | `1.0` | 光程长度（**cm**），用于归一化至摩尔吸光系数。 |
| `WAVELENGTH_DETECTED` | 数字 | `0` | 检测波长（用于动力学图标题）。 |

### 数据预处理与校正
| 关键词 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `X_CORR` | 数字或数组 | `0.0` | X 轴平移量（逐个运行指定）。 |
| `Y_CORR` | 数字或数组 | `0.0` | Y 轴平移量。 |
| `X_SCALE` | 数字或数组 | `1.0` | X 轴缩放因子。 |
| `Y_SCALE` | 数字或数组 | `1.0` | Y 轴缩放因子。 |
| `X_CUT_AFTER` | 数字 | `null` | 截断 X 轴大于该值的数据点。 |
| `Y_SCALE_FACTOR_IN_UNIT` | 数字 | `1.0` | 与浓度归一化配合，用于调整单位。 |
| `AUTO_FIND_TIME_ZERO` | 布尔 | `false` | 是否自动寻找时间零点（基于y值的最大值，该功能尚待进一步完善）。 |
| `NORMALIZATION_METHOD` | 整数 | `0` | I. 对光谱进行归一化：<br>`0` - 仅使用 `Y_CORR` 校正；<br>`1` - 归一化至摩尔吸光系数（需 `CONCENTRATION_LIST` 和 `LENGTH`）；<br>`2` - 按最大值归一化；<br>II. 对动力学曲线在拟合前进行归一化（不反映至作图上）:<br>`0` - 不做归一化（仍适用 `Y_CORR` 校正）；<br>`1` - 取基线的平均值，对曲线进行统一扣减；<br>`2` - 扣减基线平均值后，按最大值归一化；<br>`3` - 按最大值归一化。|
| `SHOW_STATISTICS` | 布尔 | `true` | 是否在终端输出动力学曲线的统计信息（噪声大小、SNR等）。 |
| `SHOW_ALL_STATISTICS` | 布尔 | `false` | 是否在终端输出更详细的统计信息（如基线、IRF 的 SNR）。 |

### 坐标轴与范围
| 关键词 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `XLABEL` | 字符串 | `""` | X 轴标签。为空时根据 `TYPE` 自动生成。 |
| `YLABEL` | 字符串 | `""` | Y 轴标签。为空时根据 `TYPE` 自动生成。 |
| `XMIN` | 数字 | `0.0` | X 轴显示下限。 |
| `XMAX` | 数字 | `0.0` | X 轴显示上限（`XMIN`与`XMAX`均为0时，自动决定X轴显示范围）。 |
| `YMIN` | 数字 | `0.0` | Y 轴显示下限。 |
| `YMAX` | 数字 | `0.0` | Y 轴显示上限（`YMIN`与`YMAX`均为0时，自动决定Y轴显示范围）。 |
| `YMAX_OF_RESIDUAL` | 数字 | `0.0` | 残差图的 Y 轴范围（对称）。其值为0时， 范围自动设为1.1*残差绝对值的最大值。|

### 拟合设置
#### 基本功能
| 关键词 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `DO_FITTING` | 布尔 | `false` | 是否对动力学数据进行拟合。 |
| `FIT_FUNCTION` | 字符串 | `null` | 拟合函数名称（见代码开头的注释或附录）。常用：`"exp_decay"`、`"exp_2decay"`、`"secondary_decay"`、`"primary_rise"` 等。 |
| `ENABLE_CUSTOM_INITIAL_GUESS` | 布尔 | `false` | 是否使用自定义初始猜测值。 |
| `CUSTOM_INITIAL_GUESS` | 数组 | `[]` | 自定义初始猜测值列表（顺序与拟合函数参数一致）。 |
| `UPPER_BOUND` | 数组 | `[]` | 参数上界（与初始猜测顺序一致）。 |
| `LOWER_BOUND` | 数组 | `[]` | 参数下界（与初始猜测顺序一致）。 |
| `FIX_VALUE` | 数组 | `[]` | 固定参数值（指定后该参数在拟合中不变）。 |
| `ERROR_ANALYSIS` | 布尔 | `false` | 是否计算参数误差（协方差矩阵）。 |
| `RETRY_FIT_IF_FAIL` | 布尔 | `true` | 拟合失败时是否允许立即调整初猜重试。 |

#### 拟合权重
| 关键词 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `WEIGHTING_FOR_FIT` | 布尔 | `false` | 是否在拟合中启用权重。 |
| `WEIGHT` | 数字 | `0.2` | 权重值（当 `WEIGHTING_AFTER` 启用时）。 |
| `WEIGHTING_AFTER` | 数字 | `0.0` | 超过该时间点后的数据点权重由1.0变为 `WEIGHT`。 |

#### 添加可变基线、卷积拟合
| 关键词 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `BASELINE` | 整数或数组 | `0` | 指定作为基线的运行编号（用于可变基线拟合）。 |
| `IRF` | 整数或数组 | `0` | 指定仪器响应函数（IRF）的运行编号（用于卷积拟合）。 |
| `IRF_WIDTH` | 数字 | `80.0` | IRF 宽度（与卷积相关）。 |
| `DISCARD_POINTS_WHEN_RECONV` | 整数 | `50` | 卷积后丢弃的末尾点数。 |
| `RECONV_TZ` | 布尔 | `false` | 卷积拟合中是否将时间零点作为自由参数。 |

#### 拟合结果显示
| 关键词 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `SHOW_FITTING_INFO` | 整数或布尔 | `1` | 决定拟合结果的显示方法：<br>`-1` - 不显示大部分内容；<br>`0` - 只在终端显示；<br>`1` - 在终端和图上均显示<br>`2` - 在终端和图上均显示，且显示更完整的模型评估指标。 |
| `POSITION_OF_FITTING_INFO` | 字符串 | `"top right"` | 拟合信息文本框位置，如 `"top left"`、`"bottom right"`。 |

### 绘图样式
| 关键词 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `TITLE0` | 字符串 | `""` | 图表标题附加内容。 |
| `TITLE_FONTSIZE` | 整数 | `18` | 标题字体大小。 |
| `FONTSIZE` | 整数 | `16` | 坐标轴标签和刻度字体大小。 |
| `FIGSIZE` | 数组 | `[10,6]` | 图形尺寸（英寸），例如 `[8,5]`。 |
| `LINEWIDTH` | 数字 | `1.5` | 曲线线宽。 |
| `COLOR_LIST` | 数组或字符串 | `[]` | 曲线颜色列表。可以是颜色名称数组（如 `["red","blue"]`），也可以是 matplotlib 颜色映射名称（如 `"viridis"`）。 |
| `COLORMAP_REVERSED` | 布尔 | `false` | 当 `COLOR_LIST` 为颜色映射名时，是否反转颜色顺序。 |
| `ENABLE_LEGEND` | 布尔 | `true` | 是否显示图例。 |
| `SHOW_RUN_NUMBER` | 布尔 | `false` | 是否在图例中附加运行编号。 |
| `AUTOLABEL` | 布尔 | `false` | 是否自动生成图例标签（如 `"Run01"`）。 |
| `LABEL_LIST` | 数组 | `[]` | 自定义图例标签列表。 |

### 交点搜索
| 关键词 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `FIND_INTERSECTIONS` | 布尔 | `false` | 是否计算前两条曲线的交点。 |
| `SHOW_INTERSECTIONS` | 布尔 | `false` | 是否在图上标记交点。 |
| `INTERSECTION_ABS_TOL` | 数字 | `1e-2` | 处于该 y 值以下的交点将被舍弃。 |

### 文件保存与交互
| 关键词 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `FILENAME` | 字符串 | `""` | 指定输出图片文件名（不含路径）。若为空，程序根据配置自动生成。 |
| `FILENAME_MODE` | 整数 | `0` | `0` - 使用 JSON 文件名；`1` - 根据配置生成描述性文件名。 |
| `COPY_FILENAME_TO_CLIPBOARD` | 布尔 | `true` | 是否将生成的文件名复制到剪贴板。 |
| `LOOP` | 布尔 | `true` | 绘图后是否进入交互循环（允许输入命令）。若设为 `false`，程序将直接退出。 |

> **注意**：部分参数（如`CONCENTRATION`、`X_CORR`、`Y_CORR`、`X_SCALE` 等）可接受单个数字（应用于所有运行）或与 `RUN_LIST` 等长的数组（逐个运行指定）。`BASELINE` 和 `IRF` 同样可接受数组以对应每个运行。


## 拟合函数说明

在动力学数据分析（`TYPE` 为 `"KinAbs"`、`"KA"` 或 `"TC-SPC"` 且 `DO_FITTING` 为 `true`）时，可通过 `FIT_FUNCTION` 参数指定拟合模型。程序支持以下拟合函数（不区分大小写，支持多种别名）：

### 指数衰减模型

| 函数名称 | 别名 | 数学表达式 | 参数说明 |
|----------|------|------------|----------|
| `linear` | `l`, `x`, `0`, `linear_decay` | $y = y_0 + k \cdot t$ | $y_0$：基线偏移<br>$k$：斜率 |
| `exp_decay` | `exp`, `decay`, `primary`, `ed`, `pd`, `1` | $y = y_0 + A \cdot e^{-t/\tau}$ | $y_0$：基线偏移<br>$A$：振幅<br>$\tau$：寿命 |
| `exp_2decay` | `exp2`, `2decay`, `double_decay`, `ded`, `dpd`, `11` | $y = y_0 + A_1 e^{-t/\tau_1} + A_2 e^{-t/\tau_2}$ | $y_0$：基线偏移<br>$A_1,A_2$：振幅<br>$\tau_1,\tau_2$：寿命 |
| `exp_3decay` | `exp3`, `3decay`, `triple_decay`, `ted`, `tpd`, `111` | $y = y_0 + A_1 e^{-t/\tau_1} + A_2 e^{-t/\tau_2} + A_3 e^{-t/\tau_3}$ | $y_0$：基线偏移<br>$A_1,A_2,A_3$：振幅<br>$\tau_1,\tau_2,\tau_3$：寿命 |

### 二级反应模型及其变种

| 函数名称 | 别名 | 数学表达式 | 参数说明 |
|----------|------|------------|----------|
| `secondary_decay` | `secondary`, `reciprocal`, `sd`, `rd`, `2` | $y = y_0 + \frac{1}{k \cdot t + r_0}$ | $y_0$：基线偏移<br>$k$：二级反应速率常数<br>$r_0$：初始倒数浓度 |
| `primary_secondary_decay` | `primary_secondary`, `psd`, `spd`, `12`, `21` | $y = y_0 + \frac{k_1}{e^{k_1(t - const)} - 2k_2}$ | $y_0$：基线偏移<br>$k_1$：一级速率常数<br>$k_2$：二级速率常数<br>$const$：时间偏移常数 |
| `primary_secondary_seperate` | `pss`, `1-2`, `2-1` | $y = y_0 + A e^{-k_1 t} + \frac{1}{k_2 t + r_0}$ | $y_0$：基线偏移<br>$A$：一级过程振幅<br>$k_1$：一级速率常数<br>$k_2$：二级速率常数<br>$r_0$：初始倒数浓度 |

### 上升模型

| 函数名称 | 别名 | 数学表达式 | 参数说明 |
|----------|------|------------|----------|
| `primary_rise` | `rise`, `pr`, `er`, `1+` | $y = y_0 + A(1 - e^{-k t})$ | $y_0$：基线偏移<br>$A$：上升振幅<br>$k$：上升速率常数 |
| `primary_rise_linear_offset` | `rise0`, `risel`, `prl`, `erl`, `1+0` | $y = y_0 + A(1 - e^{-k t}) + B t$ | $y_0$：基线偏移<br>$A$：上升振幅<br>$k$：上升速率常数<br>$B$：线性背景斜率 |
| `primary_rise_double_offset` | `rise2`, `prd`, `erd`, `1+00` | $y = y_0 + A(1 - e^{-k(t-t_0)}) + B t$ | $y_0$：基线偏移<br>$A$：上升振幅<br>$k$：上升速率常数<br>$B$：线性背景斜率<br>$t_0$：时间偏移 |
| `primary_rise_triple_offset` | `rise3`, `prt`, `ert`, `1+000` | $y = y_0 + A(C - e^{-k(t-t_0)}) + B t$ | $y_0$：基线偏移<br>$A$：上升振幅<br>$k$：上升速率常数<br>$B$：线性背景斜率<br>$C$：常数偏移<br>$t_0$：时间偏移 |
| `double_primary_rise` | `double_rise`, `dpr`, `11+` | $y = y_0 + A_1(1 - e^{-k_1 t}) + A_2(1 - e^{-k_2 t})$ | $y_0$：基线偏移<br>$A_1,A_2$：上升振幅<br>$k_1,k_2$：上升速率常数 |
| `double_primary_rise_linear_offset` | `double_rise0`, `dprl`, `derl`, `110+` | $y = y_0 + A_1(1 - e^{-k_1 t}) + A_2(1 - e^{-k_2 t}) + B t$ | $y_0$：基线偏移<br>$A_1,A_2$：上升振幅<br>$k_1,k_2$：上升速率常数<br>$B$：线性背景斜率 |

### 串联模型

| 函数名称 | 别名 | 数学表达式 | 参数说明 |
|----------|------|------------|----------|
| `primary_cascade` | `cascade`, `pc`, `1-1` | $y = y_0 + A(e^{-k_1 t} - e^{-k_2 t})$ | $y_0$：基线偏移<br>$A$：振幅<br>$k_1,k_2$：上升和衰减速率常数 |

### 高斯模型

| 函数名称 | 别名 | 数学表达式 | 参数说明 |
|----------|------|------------|----------|
| `gaussian` | `g` | $y = y_0 + A e^{\frac{(t-t_0)^2}{2\sigma^2}}$ | $y_0$：基线偏移<br>$A$：峰值振幅<br>$t_0$：峰值位置<br>$\sigma$：宽度参数 |


### 使用说明

1. **参数顺序**：JSON 文件中指定 `CUSTOM_INITIAL_GUESS`、`UPPER_BOUND`、`LOWER_BOUND`、`FIX_VALUE` 时，必须严格按照上表中参数顺序提供。

2. **速率常数单位**：
   - 一级速率常数（$k_1$）单位为 `时间单位⁻¹`（如 `ns⁻¹`、`μs⁻¹`）
   - 二级速率常数（$k_2$）单位为 `(时间单位·a.u.)⁻¹`，需确定ΔOD与样品浓度之间的比例系数后，才能换算为浓度速率常数。

3. **时间单位**：程序会根据 `X_SCALE` 自动推断时间单位（ns/μs/ms/s），并在拟合结果中正确显示。

4. **拟合质量评估**：拟合完成后会显示 $R^2$、调整后 $R^2$、$\chi^2$、RMSE 等统计量，帮助判断拟合效果。


## 声明与联系方式
作者写这些东西就是纯图一乐的，没有明确的开发计划，想到啥就写啥，如有问题敬请提出。此readme文件使用Deepseek生成。

- **问题反馈**：欢迎在项目的 [GitHub Issues] 提交问题、建议或功能请求。
- **邮件**：zhuzl24@mails.tsinghua.edu.cn（开发初期，可临时联系作者）

---
